<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Photo GeoTagger - AI-Powered Location Detection</title>

    <!-- Leaflet CSS for maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            min-height: 100vh;
            color: #fff;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        header {
            text-align: center;
            padding: 30px 0;
        }

        header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        header p {
            color: #888;
            font-size: 1.1rem;
        }

        /* API Key Section */
        .api-section {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .api-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .api-input-group {
            display: flex;
            gap: 10px;
        }

        .api-input-group input {
            flex: 1;
            padding: 12px 16px;
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            background: rgba(0,0,0,0.3);
            color: #fff;
            font-size: 1rem;
        }

        .api-input-group input:focus {
            outline: none;
            border-color: #3a7bd5;
        }

        .api-status {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9rem;
            margin-top: 10px;
        }

        .api-status.connected {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }

        .api-status.disconnected {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }

        /* Upload Zone */
        .upload-zone {
            border: 3px dashed rgba(255,255,255,0.2);
            border-radius: 16px;
            padding: 60px 40px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 20px;
        }

        .upload-zone:hover, .upload-zone.dragover {
            border-color: #3a7bd5;
            background: rgba(58, 123, 213, 0.1);
        }

        .upload-zone svg {
            width: 80px;
            height: 80px;
            margin-bottom: 20px;
            opacity: 0.5;
        }

        .upload-zone h3 {
            font-size: 1.5rem;
            margin-bottom: 10px;
        }

        .upload-zone p {
            color: #888;
        }

        #fileInput {
            display: none;
        }

        /* Stats Bar */
        .stats-bar {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .stat-card .number {
            font-size: 2rem;
            font-weight: bold;
            color: #3a7bd5;
        }

        .stat-card .label {
            color: #888;
            font-size: 0.9rem;
            margin-top: 5px;
        }

        /* Control Buttons */
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            color: #fff;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(58, 123, 213, 0.4);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: rgba(255,255,255,0.1);
            color: #fff;
        }

        .btn-secondary:hover {
            background: rgba(255,255,255,0.2);
        }

        .btn-success {
            background: linear-gradient(90deg, #2ecc71, #27ae60);
            color: #fff;
        }

        /* Progress Bar */
        .progress-section {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            display: none;
        }

        .progress-section.active {
            display: block;
        }

        .progress-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .progress-bar {
            height: 8px;
            background: rgba(255,255,255,0.1);
            border-radius: 4px;
            overflow: hidden;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #00d2ff, #3a7bd5);
            border-radius: 4px;
            transition: width 0.3s ease;
            width: 0%;
        }

        .progress-log {
            margin-top: 15px;
            max-height: 150px;
            overflow-y: auto;
            font-family: monospace;
            font-size: 0.85rem;
            color: #888;
        }

        .progress-log .success {
            color: #2ecc71;
        }

        .progress-log .error {
            color: #e74c3c;
        }

        /* Image Grid */
        .image-grid-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .filter-tabs {
            display: flex;
            gap: 10px;
        }

        .filter-tab {
            padding: 8px 16px;
            background: rgba(255,255,255,0.05);
            border: none;
            border-radius: 20px;
            color: #888;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-tab.active {
            background: #3a7bd5;
            color: #fff;
        }

        .image-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 30px;
        }

        .image-card {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            overflow: hidden;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
        }

        .image-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        .image-card img {
            width: 100%;
            height: 150px;
            object-fit: cover;
        }

        .image-card .info {
            padding: 12px;
        }

        .image-card .filename {
            font-size: 0.85rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .image-card .location {
            font-size: 0.75rem;
            color: #888;
            margin-top: 5px;
        }

        .image-card .status-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .status-badge.pending {
            background: rgba(241, 196, 15, 0.9);
            color: #000;
        }

        .status-badge.processing {
            background: rgba(52, 152, 219, 0.9);
            color: #fff;
        }

        .status-badge.tagged {
            background: rgba(46, 204, 113, 0.9);
            color: #fff;
        }

        .status-badge.error {
            background: rgba(231, 76, 60, 0.9);
            color: #fff;
        }

        .status-badge.existing {
            background: rgba(155, 89, 182, 0.9);
            color: #fff;
        }

        /* Map Section */
        .map-section {
            background: rgba(255,255,255,0.05);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .map-section h3 {
            margin-bottom: 15px;
        }

        #resultsMap {
            height: 400px;
            border-radius: 8px;
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1a1a2e;
            border-radius: 16px;
            max-width: 900px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .modal-close {
            background: none;
            border: none;
            color: #fff;
            font-size: 1.5rem;
            cursor: pointer;
        }

        .modal-body {
            padding: 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .modal-image {
            width: 100%;
            border-radius: 8px;
        }

        .modal-details h4 {
            margin-bottom: 15px;
            color: #3a7bd5;
        }

        .detail-row {
            display: flex;
            justify-content: space-between;
            padding: 10px 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }

        .detail-row .label {
            color: #888;
        }

        #modalMap {
            height: 200px;
            border-radius: 8px;
            margin-top: 15px;
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #666;
        }

        .empty-state svg {
            width: 100px;
            height: 100px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .modal-body {
                grid-template-columns: 1fr;
            }

            .api-input-group {
                flex-direction: column;
            }

            .controls {
                flex-direction: column;
            }

            .btn {
                width: 100%;
                justify-content: center;
            }
        }

        /* Rate limit warning */
        .rate-limit-warning {
            background: rgba(241, 196, 15, 0.1);
            border: 1px solid rgba(241, 196, 15, 0.3);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            display: none;
        }

        .rate-limit-warning.active {
            display: block;
        }

        /* Settings section */
        .settings-row {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-top: 15px;
        }

        .settings-row label {
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
        }

        .settings-row input[type="number"] {
            width: 80px;
            padding: 8px;
            border: 2px solid rgba(255,255,255,0.1);
            border-radius: 6px;
            background: rgba(0,0,0,0.3);
            color: #fff;
        }

        .help-text {
            font-size: 0.85rem;
            color: #666;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>Photo GeoTagger</h1>
            <p>AI-powered location detection for your photos using GeoSpy</p>
        </header>

        <!-- API Key Section -->
        <div class="api-section">
            <label for="apiKey">GeoSpy API Key</label>
            <div class="api-input-group">
                <input type="password" id="apiKey" placeholder="Enter your GeoSpy API key..." />
                <button class="btn btn-secondary" onclick="toggleApiKeyVisibility()">Show</button>
                <button class="btn btn-primary" onclick="saveApiKey()">Save Key</button>
            </div>
            <div id="apiStatus" class="api-status disconnected">
                <span class="dot">‚óè</span> Not configured
            </div>
            <div class="help-text">
                Get your API key from <a href="https://geospy.ai" target="_blank" style="color: #3a7bd5;">geospy.ai</a>
                (Free tier: 20 images/day)
            </div>
            <div class="settings-row">
                <label>
                    Delay between requests (ms):
                    <input type="number" id="requestDelay" value="1000" min="500" max="10000" step="100" />
                </label>
                <span class="help-text">Increase if you hit rate limits</span>
            </div>
        </div>

        <!-- Rate Limit Warning -->
        <div id="rateLimitWarning" class="rate-limit-warning">
            ‚ö†Ô∏è <strong>Rate limit reached.</strong> Please wait before processing more images, or upgrade your GeoSpy plan.
        </div>

        <!-- Upload Zone -->
        <div class="upload-zone" id="uploadZone" onclick="document.getElementById('fileInput').click()">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
            </svg>
            <h3>Drop photos here</h3>
            <p>or click to browse (supports JPG, PNG, HEIC - up to 6000+ files)</p>
        </div>
        <input type="file" id="fileInput" multiple accept="image/*,.heic,.heif" />

        <!-- Stats -->
        <div class="stats-bar">
            <div class="stat-card">
                <div class="number" id="totalCount">0</div>
                <div class="label">Total Photos</div>
            </div>
            <div class="stat-card">
                <div class="number" id="pendingCount">0</div>
                <div class="label">Pending</div>
            </div>
            <div class="stat-card">
                <div class="number" id="taggedCount">0</div>
                <div class="label">Tagged</div>
            </div>
            <div class="stat-card">
                <div class="number" id="existingCount">0</div>
                <div class="label">Already Had GPS</div>
            </div>
            <div class="stat-card">
                <div class="number" id="errorCount">0</div>
                <div class="label">Errors</div>
            </div>
        </div>

        <!-- Controls -->
        <div class="controls">
            <button class="btn btn-primary" id="processBtn" onclick="startProcessing()" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Start Processing
            </button>
            <button class="btn btn-secondary" id="stopBtn" onclick="stopProcessing()" style="display:none;">
                Stop
            </button>
            <button class="btn btn-success" id="downloadBtn" onclick="downloadAll()" disabled>
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
                </svg>
                Download All Tagged Photos
            </button>
            <button class="btn btn-secondary" onclick="clearAll()">
                Clear All
            </button>
        </div>

        <!-- Progress -->
        <div class="progress-section" id="progressSection">
            <div class="progress-header">
                <span id="progressText">Processing...</span>
                <span id="progressPercent">0%</span>
            </div>
            <div class="progress-bar">
                <div class="progress-fill" id="progressFill"></div>
            </div>
            <div class="progress-log" id="progressLog"></div>
        </div>

        <!-- Map -->
        <div class="map-section">
            <h3>üìç Location Results</h3>
            <div id="resultsMap"></div>
        </div>

        <!-- Image Grid -->
        <div class="image-grid-header">
            <h3>Photos</h3>
            <div class="filter-tabs">
                <button class="filter-tab active" onclick="filterImages('all')">All</button>
                <button class="filter-tab" onclick="filterImages('pending')">Pending</button>
                <button class="filter-tab" onclick="filterImages('tagged')">Tagged</button>
                <button class="filter-tab" onclick="filterImages('existing')">Had GPS</button>
                <button class="filter-tab" onclick="filterImages('error')">Errors</button>
            </div>
        </div>
        <div class="image-grid" id="imageGrid">
            <div class="empty-state">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                <p>No photos yet. Drop some images above to get started!</p>
            </div>
        </div>
    </div>

    <!-- Image Detail Modal -->
    <div class="modal" id="imageModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 id="modalTitle">Image Details</h3>
                <button class="modal-close" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <div>
                    <img id="modalImage" class="modal-image" src="" alt="" />
                </div>
                <div class="modal-details">
                    <h4>Location Information</h4>
                    <div class="detail-row">
                        <span class="label">Latitude</span>
                        <span id="modalLat">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">Longitude</span>
                        <span id="modalLng">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">Address</span>
                        <span id="modalAddress">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">Confidence</span>
                        <span id="modalConfidence">-</span>
                    </div>
                    <div class="detail-row">
                        <span class="label">Status</span>
                        <span id="modalStatus">-</span>
                    </div>
                    <div id="modalMap"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Libraries -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/piexifjs/1.0.6/piexif.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>

    <script>
        // ============================================
        // State Management
        // ============================================
        let photos = []; // Array of photo objects
        let isProcessing = false;
        let shouldStop = false;
        let map = null;
        let modalMap = null;
        let markers = [];
        let currentFilter = 'all';

        // Photo object structure:
        // {
        //   id: string,
        //   file: File,
        //   name: string,
        //   thumbnail: string (data URL),
        //   originalDataUrl: string,
        //   status: 'pending' | 'processing' | 'tagged' | 'error' | 'existing',
        //   lat: number | null,
        //   lng: number | null,
        //   address: string | null,
        //   confidence: number | null,
        //   error: string | null,
        //   existingGps: boolean,
        //   modifiedDataUrl: string | null
        // }

        // ============================================
        // Initialization
        // ============================================
        document.addEventListener('DOMContentLoaded', () => {
            initMap();
            loadApiKey();
            setupDragDrop();
            setupFileInput();
        });

        function initMap() {
            map = L.map('resultsMap').setView([20, 0], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
        }

        function setupDragDrop() {
            const zone = document.getElementById('uploadZone');

            ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
                zone.addEventListener(eventName, preventDefaults, false);
                document.body.addEventListener(eventName, preventDefaults, false);
            });

            ['dragenter', 'dragover'].forEach(eventName => {
                zone.addEventListener(eventName, () => zone.classList.add('dragover'), false);
            });

            ['dragleave', 'drop'].forEach(eventName => {
                zone.addEventListener(eventName, () => zone.classList.remove('dragover'), false);
            });

            zone.addEventListener('drop', handleDrop, false);
        }

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        function handleDrop(e) {
            const files = e.dataTransfer.files;
            handleFiles(files);
        }

        function setupFileInput() {
            document.getElementById('fileInput').addEventListener('change', (e) => {
                handleFiles(e.target.files);
            });
        }

        // ============================================
        // API Key Management
        // ============================================
        function saveApiKey() {
            const key = document.getElementById('apiKey').value.trim();
            if (key) {
                localStorage.setItem('geospy_api_key', key);
                updateApiStatus(true);
                updateProcessButton();
            }
        }

        function loadApiKey() {
            const key = localStorage.getItem('geospy_api_key');
            if (key) {
                document.getElementById('apiKey').value = key;
                updateApiStatus(true);
            }
        }

        function getApiKey() {
            return document.getElementById('apiKey').value.trim() || localStorage.getItem('geospy_api_key');
        }

        function updateApiStatus(connected) {
            const status = document.getElementById('apiStatus');
            if (connected) {
                status.className = 'api-status connected';
                status.innerHTML = '<span class="dot">‚óè</span> API Key configured';
            } else {
                status.className = 'api-status disconnected';
                status.innerHTML = '<span class="dot">‚óè</span> Not configured';
            }
        }

        function toggleApiKeyVisibility() {
            const input = document.getElementById('apiKey');
            const btn = event.target;
            if (input.type === 'password') {
                input.type = 'text';
                btn.textContent = 'Hide';
            } else {
                input.type = 'password';
                btn.textContent = 'Show';
            }
        }

        // ============================================
        // File Handling
        // ============================================
        async function handleFiles(files) {
            const imageFiles = Array.from(files).filter(f =>
                f.type.startsWith('image/') ||
                f.name.toLowerCase().endsWith('.heic') ||
                f.name.toLowerCase().endsWith('.heif')
            );

            if (imageFiles.length === 0) {
                alert('No valid image files found. Please select JPG, PNG, or HEIC files.');
                return;
            }

            log(`Loading ${imageFiles.length} images...`);

            // Process in batches to avoid memory issues
            const batchSize = 50;
            for (let i = 0; i < imageFiles.length; i += batchSize) {
                const batch = imageFiles.slice(i, i + batchSize);
                await Promise.all(batch.map(processFile));
                updateStats();
                renderGrid();
                log(`Loaded ${Math.min(i + batchSize, imageFiles.length)} / ${imageFiles.length} images`);
            }

            updateProcessButton();
            log(`‚úì ${imageFiles.length} images loaded successfully`);
        }

        async function processFile(file) {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.onload = async (e) => {
                    const dataUrl = e.target.result;

                    // Check for existing GPS data
                    let existingGps = false;
                    let existingLat = null;
                    let existingLng = null;

                    try {
                        const exif = piexif.load(dataUrl);
                        if (exif.GPS && exif.GPS[piexif.GPSIFD.GPSLatitude] && exif.GPS[piexif.GPSIFD.GPSLongitude]) {
                            existingLat = convertDMSToDD(
                                exif.GPS[piexif.GPSIFD.GPSLatitude],
                                exif.GPS[piexif.GPSIFD.GPSLatitudeRef]
                            );
                            existingLng = convertDMSToDD(
                                exif.GPS[piexif.GPSIFD.GPSLongitude],
                                exif.GPS[piexif.GPSIFD.GPSLongitudeRef]
                            );
                            if (existingLat !== null && existingLng !== null) {
                                existingGps = true;
                            }
                        }
                    } catch (err) {
                        // No EXIF or parsing error, continue
                    }

                    // Create thumbnail
                    const thumbnail = await createThumbnail(dataUrl, 400);

                    const photo = {
                        id: generateId(),
                        file: file,
                        name: file.name,
                        thumbnail: thumbnail,
                        originalDataUrl: dataUrl,
                        status: existingGps ? 'existing' : 'pending',
                        lat: existingLat,
                        lng: existingLng,
                        address: null,
                        confidence: null,
                        error: null,
                        existingGps: existingGps,
                        modifiedDataUrl: null
                    };

                    photos.push(photo);

                    if (existingGps) {
                        addMarker(photo);
                    }

                    resolve();
                };
                reader.readAsDataURL(file);
            });
        }

        function createThumbnail(dataUrl, maxSize) {
            return new Promise((resolve) => {
                const img = new Image();
                img.onload = () => {
                    const canvas = document.createElement('canvas');
                    let width = img.width;
                    let height = img.height;

                    if (width > height) {
                        if (width > maxSize) {
                            height *= maxSize / width;
                            width = maxSize;
                        }
                    } else {
                        if (height > maxSize) {
                            width *= maxSize / height;
                            height = maxSize;
                        }
                    }

                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    resolve(canvas.toDataURL('image/jpeg', 0.7));
                };
                img.src = dataUrl;
            });
        }

        function generateId() {
            return Math.random().toString(36).substr(2, 9);
        }

        // ============================================
        // GPS Coordinate Conversion
        // ============================================
        function convertDMSToDD(dms, ref) {
            if (!dms || dms.length !== 3) return null;

            const degrees = dms[0][0] / dms[0][1];
            const minutes = dms[1][0] / dms[1][1];
            const seconds = dms[2][0] / dms[2][1];

            let dd = degrees + minutes / 60 + seconds / 3600;

            if (ref === 'S' || ref === 'W') {
                dd = -dd;
            }

            return dd;
        }

        function convertDDToDMS(dd) {
            const absolute = Math.abs(dd);
            const degrees = Math.floor(absolute);
            const minutesNotTruncated = (absolute - degrees) * 60;
            const minutes = Math.floor(minutesNotTruncated);
            const seconds = (minutesNotTruncated - minutes) * 60;

            return [
                [degrees, 1],
                [minutes, 1],
                [Math.round(seconds * 1000), 1000]
            ];
        }

        // ============================================
        // GeoSpy API Integration
        // ============================================
        async function callGeoSpyAPI(base64Image) {
            const apiKey = getApiKey();
            if (!apiKey) {
                throw new Error('API key not configured');
            }

            // Remove data URL prefix if present
            const imageData = base64Image.includes(',')
                ? base64Image.split(',')[1]
                : base64Image;

            const response = await fetch('https://dev.geospy.ai/predict', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${apiKey}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    inputs: { image: imageData },
                    top_k: 5
                })
            });

            if (response.status === 429) {
                throw new Error('RATE_LIMIT');
            }

            if (!response.ok) {
                const text = await response.text();
                throw new Error(`API Error: ${response.status} - ${text}`);
            }

            return await response.json();
        }

        // ============================================
        // Processing
        // ============================================
        async function startProcessing() {
            const apiKey = getApiKey();
            if (!apiKey) {
                alert('Please enter your GeoSpy API key first.');
                return;
            }

            const pendingPhotos = photos.filter(p => p.status === 'pending');
            if (pendingPhotos.length === 0) {
                alert('No pending photos to process.');
                return;
            }

            isProcessing = true;
            shouldStop = false;
            document.getElementById('processBtn').disabled = true;
            document.getElementById('processBtn').style.display = 'none';
            document.getElementById('stopBtn').style.display = 'inline-flex';
            document.getElementById('progressSection').classList.add('active');
            document.getElementById('rateLimitWarning').classList.remove('active');

            const delay = parseInt(document.getElementById('requestDelay').value) || 1000;
            let processed = 0;

            for (const photo of pendingPhotos) {
                if (shouldStop) {
                    log('‚èπ Processing stopped by user');
                    break;
                }

                photo.status = 'processing';
                updateStats();
                renderGrid();
                updateProgress(processed, pendingPhotos.length, `Processing: ${photo.name}`);

                try {
                    const result = await callGeoSpyAPI(photo.originalDataUrl);

                    // Parse GeoSpy response
                    if (result && result.geo_predictions && result.geo_predictions.length > 0) {
                        const prediction = result.geo_predictions[0];
                        photo.lat = prediction.coordinates[0];
                        photo.lng = prediction.coordinates[1];
                        photo.address = prediction.address || `${prediction.city || ''}, ${prediction.country || ''}`.trim();
                        photo.confidence = prediction.score || null;
                        photo.status = 'tagged';

                        // Write GPS to EXIF
                        try {
                            photo.modifiedDataUrl = writeGPSToExif(
                                photo.originalDataUrl,
                                photo.lat,
                                photo.lng
                            );
                        } catch (exifErr) {
                            // If EXIF writing fails, keep original
                            photo.modifiedDataUrl = photo.originalDataUrl;
                            log(`‚ö† Could not write EXIF for ${photo.name}: ${exifErr.message}`, 'error');
                        }

                        addMarker(photo);
                        log(`‚úì ${photo.name}: ${photo.address} (${photo.lat.toFixed(4)}, ${photo.lng.toFixed(4)})`, 'success');
                    } else {
                        photo.status = 'error';
                        photo.error = 'No location predictions returned';
                        log(`‚úó ${photo.name}: No location found`, 'error');
                    }
                } catch (err) {
                    if (err.message === 'RATE_LIMIT') {
                        photo.status = 'pending'; // Reset to pending
                        document.getElementById('rateLimitWarning').classList.add('active');
                        log(`‚ö† Rate limit reached. Stopping...`, 'error');
                        break;
                    }
                    photo.status = 'error';
                    photo.error = err.message;
                    log(`‚úó ${photo.name}: ${err.message}`, 'error');
                }

                processed++;
                updateStats();
                renderGrid();
                updateProgress(processed, pendingPhotos.length);

                // Delay between requests
                if (!shouldStop && processed < pendingPhotos.length) {
                    await sleep(delay);
                }
            }

            isProcessing = false;
            document.getElementById('processBtn').disabled = false;
            document.getElementById('processBtn').style.display = 'inline-flex';
            document.getElementById('stopBtn').style.display = 'none';
            updateProcessButton();
            updateProgress(processed, pendingPhotos.length, 'Complete!');
            log(`‚úì Processing complete. ${photos.filter(p => p.status === 'tagged').length} photos tagged.`);
        }

        function stopProcessing() {
            shouldStop = true;
            log('Stopping after current image...');
        }

        function writeGPSToExif(dataUrl, lat, lng) {
            let exifObj;
            try {
                exifObj = piexif.load(dataUrl);
            } catch (e) {
                // No existing EXIF, create new
                exifObj = { '0th': {}, 'Exif': {}, 'GPS': {}, '1st': {}, 'thumbnail': null };
            }

            // Set GPS data
            exifObj.GPS[piexif.GPSIFD.GPSLatitudeRef] = lat >= 0 ? 'N' : 'S';
            exifObj.GPS[piexif.GPSIFD.GPSLatitude] = convertDDToDMS(lat);
            exifObj.GPS[piexif.GPSIFD.GPSLongitudeRef] = lng >= 0 ? 'E' : 'W';
            exifObj.GPS[piexif.GPSIFD.GPSLongitude] = convertDDToDMS(lng);
            exifObj.GPS[piexif.GPSIFD.GPSAltitudeRef] = 0;
            exifObj.GPS[piexif.GPSIFD.GPSAltitude] = [0, 1];

            const exifBytes = piexif.dump(exifObj);
            return piexif.insert(exifBytes, dataUrl);
        }

        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        // ============================================
        // UI Updates
        // ============================================
        function updateStats() {
            document.getElementById('totalCount').textContent = photos.length;
            document.getElementById('pendingCount').textContent = photos.filter(p => p.status === 'pending').length;
            document.getElementById('taggedCount').textContent = photos.filter(p => p.status === 'tagged').length;
            document.getElementById('existingCount').textContent = photos.filter(p => p.status === 'existing').length;
            document.getElementById('errorCount').textContent = photos.filter(p => p.status === 'error').length;
        }

        function updateProcessButton() {
            const btn = document.getElementById('processBtn');
            const downloadBtn = document.getElementById('downloadBtn');
            const hasPending = photos.some(p => p.status === 'pending');
            const hasTagged = photos.some(p => p.status === 'tagged' || p.status === 'existing');
            const hasApiKey = !!getApiKey();

            btn.disabled = !hasPending || !hasApiKey || isProcessing;
            downloadBtn.disabled = !hasTagged;
        }

        function updateProgress(current, total, text) {
            const percent = total > 0 ? Math.round((current / total) * 100) : 0;
            document.getElementById('progressFill').style.width = `${percent}%`;
            document.getElementById('progressPercent').textContent = `${percent}%`;
            if (text) {
                document.getElementById('progressText').textContent = text;
            }
        }

        function log(message, type = '') {
            const logEl = document.getElementById('progressLog');
            const line = document.createElement('div');
            line.className = type;
            line.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logEl.appendChild(line);
            logEl.scrollTop = logEl.scrollHeight;
        }

        function renderGrid() {
            const grid = document.getElementById('imageGrid');
            let filtered = photos;

            if (currentFilter !== 'all') {
                filtered = photos.filter(p => p.status === currentFilter);
            }

            if (filtered.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                        <p>${currentFilter === 'all' ? 'No photos yet. Drop some images above to get started!' : 'No photos in this category.'}</p>
                    </div>
                `;
                return;
            }

            grid.innerHTML = filtered.map(photo => `
                <div class="image-card" onclick="showModal('${photo.id}')">
                    <span class="status-badge ${photo.status}">${getStatusLabel(photo.status)}</span>
                    <img src="${photo.thumbnail}" alt="${photo.name}" loading="lazy" />
                    <div class="info">
                        <div class="filename">${photo.name}</div>
                        <div class="location">${photo.address || (photo.lat ? `${photo.lat.toFixed(4)}, ${photo.lng.toFixed(4)}` : 'No location')}</div>
                    </div>
                </div>
            `).join('');
        }

        function getStatusLabel(status) {
            const labels = {
                pending: 'Pending',
                processing: 'Processing...',
                tagged: 'Tagged',
                error: 'Error',
                existing: 'Had GPS'
            };
            return labels[status] || status;
        }

        function filterImages(filter) {
            currentFilter = filter;
            document.querySelectorAll('.filter-tab').forEach(tab => {
                tab.classList.toggle('active', tab.textContent.toLowerCase().includes(filter) || (filter === 'all' && tab.textContent === 'All'));
            });
            renderGrid();
        }

        // ============================================
        // Map Markers
        // ============================================
        function addMarker(photo) {
            if (!photo.lat || !photo.lng) return;

            const marker = L.marker([photo.lat, photo.lng])
                .addTo(map)
                .bindPopup(`
                    <strong>${photo.name}</strong><br>
                    ${photo.address || ''}<br>
                    <small>${photo.lat.toFixed(6)}, ${photo.lng.toFixed(6)}</small>
                `);

            markers.push({ id: photo.id, marker });

            // Fit bounds to show all markers
            if (markers.length === 1) {
                map.setView([photo.lat, photo.lng], 10);
            } else {
                const group = L.featureGroup(markers.map(m => m.marker));
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        function clearMarkers() {
            markers.forEach(m => map.removeLayer(m.marker));
            markers = [];
        }

        // ============================================
        // Modal
        // ============================================
        function showModal(photoId) {
            const photo = photos.find(p => p.id === photoId);
            if (!photo) return;

            document.getElementById('modalTitle').textContent = photo.name;
            document.getElementById('modalImage').src = photo.thumbnail;
            document.getElementById('modalLat').textContent = photo.lat ? photo.lat.toFixed(6) : '-';
            document.getElementById('modalLng').textContent = photo.lng ? photo.lng.toFixed(6) : '-';
            document.getElementById('modalAddress').textContent = photo.address || '-';
            document.getElementById('modalConfidence').textContent = photo.confidence ? `${(photo.confidence * 100).toFixed(1)}%` : '-';
            document.getElementById('modalStatus').textContent = getStatusLabel(photo.status);

            document.getElementById('imageModal').classList.add('active');

            // Initialize modal map
            setTimeout(() => {
                if (modalMap) {
                    modalMap.remove();
                }

                if (photo.lat && photo.lng) {
                    modalMap = L.map('modalMap').setView([photo.lat, photo.lng], 12);
                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '¬© OSM'
                    }).addTo(modalMap);
                    L.marker([photo.lat, photo.lng]).addTo(modalMap);
                }
            }, 100);
        }

        function closeModal() {
            document.getElementById('imageModal').classList.remove('active');
            if (modalMap) {
                modalMap.remove();
                modalMap = null;
            }
        }

        // Close modal on outside click
        document.getElementById('imageModal').addEventListener('click', (e) => {
            if (e.target.id === 'imageModal') {
                closeModal();
            }
        });

        // ============================================
        // Download
        // ============================================
        async function downloadAll() {
            const taggedPhotos = photos.filter(p =>
                (p.status === 'tagged' && p.modifiedDataUrl) ||
                (p.status === 'existing')
            );

            if (taggedPhotos.length === 0) {
                alert('No tagged photos to download.');
                return;
            }

            log(`Preparing ${taggedPhotos.length} photos for download...`);

            const zip = new JSZip();

            for (const photo of taggedPhotos) {
                const dataUrl = photo.modifiedDataUrl || photo.originalDataUrl;
                const base64 = dataUrl.split(',')[1];
                const ext = photo.name.split('.').pop().toLowerCase();
                const filename = photo.name.endsWith('.jpg') || photo.name.endsWith('.jpeg')
                    ? photo.name
                    : photo.name.replace(/\.[^.]+$/, '.jpg');

                zip.file(filename, base64, { base64: true });
            }

            log('Creating ZIP file...');

            const content = await zip.generateAsync({
                type: 'blob',
                compression: 'DEFLATE',
                compressionOptions: { level: 6 }
            }, (metadata) => {
                log(`Compressing: ${metadata.percent.toFixed(0)}%`);
            });

            // Download
            const url = URL.createObjectURL(content);
            const a = document.createElement('a');
            a.href = url;
            a.download = `geotagged-photos-${new Date().toISOString().slice(0,10)}.zip`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);

            log(`‚úì Downloaded ${taggedPhotos.length} photos!`, 'success');
        }

        // ============================================
        // Clear All
        // ============================================
        function clearAll() {
            if (photos.length > 0 && !confirm('Are you sure you want to clear all photos?')) {
                return;
            }

            photos = [];
            clearMarkers();
            updateStats();
            renderGrid();
            updateProcessButton();
            document.getElementById('progressSection').classList.remove('active');
            document.getElementById('progressLog').innerHTML = '';
            document.getElementById('rateLimitWarning').classList.remove('active');
        }
    </script>
</body>
</html>
